[Скачать](https://sre.google/resources/practices-and-processes/anatomy-of-an-incident/)

### Что такое инцидент в гугле
Это проблема, которая
- должна быть эскалирована (т.е. нужно позвать на помощь больше людей для ее решения)
- ей должны заняться немедленно
- и организиванно

Часто инцидент - это незапланированный outage (перебой в работе).

**Важно измерять надежность (reliability) и влияние на пользователей, а не кол-во инцидентов**

В противном случае люди будут саботировать процесс заведения новых инцидентов и всячески его избегать что бы не ухудшать свои показатели.

Надежность (reliability) -  это не просто доступность. Чем меньше, короче и быстрее исправляется outage (перебой в работе) - тем система надежнее. И важно это измерять со стороны пользователей.

### Алерты

Важно что бы алерт был "actionable" - он действительно должен требовать каких-то действий со стороны человека. Это не должно быть простое информирования о каких-то скачках метрик или ошибках. Не нужно напрягать дежурных множеством алертов, которые не требуют никаких срочных действия прямо в данный момент.
Надо постараться автоматизировать обработку проблем 

### Устраивайте учения
Устраивайте учения что бы отточить взаимодействия, роли, улучшить свои системы.

## Scaling Incident Management
Назначте incident responder (ответсвенного, кому будут звонить дежурные) для каждого компонента ваших систем. Пусть они обычно будут доступны только в рабочее время, но можно тоже добавить их в календарь дежурств. Это облегчит дежурному поиск того, кому можно эскалировать инцидент.

### System-of-System (SoS) Responders
SoS responder - ответсвенный за группу компонентов, который понимает как они связаны

В гугле есть:
 - Product-focused incident response teams (IRTs) - response team отдельного продукта. Например YouTube или Gmail.
 - Technical incident response team (Tech IRT) - последняя линия. Отряд спецназа, который может разобраться в кросс-продуктовых проблемах
Члены Tech IRT занимаются своими продуктами, но иногдя дежурят 24x7
Если вы не Гугл - начните хотя бы с того, что бы составить страничку в wiki, где вы опишите хотя бы несколько людей, ответственных за тот или иной компонет. Лучше если вы сделайте таблицу <компонент>-<команда>-<ответсвенный за инциденты из этой команды>

### Incident Response Organizational Structure
#### Common protocol
Все используют одинаковые правила игры. Каждый человек знает свою роль (Incident commander, scriber, communication responder и т.д.)
### Trust & respect
Все доверяют и уважают дежерного. Дежурный это не наказание или обязанность - а ответсвенная роль, которая, как правило, назначается самым опытным сотрудникам или сотрудникам, в знаниях и опыте которых уверены его коллеги.
### Transparency
Постмортемы и разбор инцидентов должны быть открытыми. Любой член любой команды должен иметь возможность прийти на них или прочитать их, и задать свои вопросы.

### Managing Risk
Старайтесь делять все, что бы люди постоянно не находились в состоянии тушения пожаров. Старайтесь закрывать проблема не больше чем за 3 дня - остановить кровотечение. После создайте задачи, и работайте с ними как с обычными рабочими задачами в обычном приоритете. Не нужно бросаться и сразу вовремя/после инцидента пытаться переделать или улучишить свой сервис. Если человек постоянно занимается тем, что тушит пожар - он сам быстро выгорает.

## Mitigation and Recovery
Первым делом занимаемся устранением импакта на пользоваителей. Потом уже думаем как нам улучишить систему.

Пишем плейбуки/ранбуки - инструкции на случай инцидента для дежурных. Постоянно улучшаем их. Это задача дежурного - постоянно улучшать документацию, и команды - берите задачи по улучшению документации как Action Item в ходе разбора постмортема.

### Action Items
Action Items (AI) - это задачи, который вы сделаете по итогам постмортема что бы предотвратить такие инциденты в будущем
В SRE Book или Anatomy of an incident ничего толком про то, как заводить AI нет, но есть про это отдельная статья тут:
https://storage.googleapis.com/gweb-research2023-media/pubtools/4393.pdf

AI в гугле делятся на категории: Investigate, Mitigate, Repair, Detect т.е.:
- Investigate - задачи на понимание того, что произошло. Иногда сложно сразу понять что случилось, для этого нужно провести дополнительную, часто довольно объемную, работу.
- Mitigate - ai, направленные на смягчение последствий инцидента. В данном контексте это то, что следует сделать срочно что бы заткнуть кровоточащую рану. Пусть это не элегантное решение, и не решает проблему в корне, но это рабочий костыль. Часто он уже готов и найдет в ходе инцидента.
- Repair - ai на восстановление полной работоспособности. Например: восстановить данные за прошлые года из бекапа, пересетапить машины и т.д.
- Detect - ai, направленные на уменьшение time to detect (времени до обнаружения инцидента). Т.е. на мониторинг, алертинг, observability и т.д.
- Prevent - как предотвратить возникнование таких инцидентов в будущем. Обычно это большие комплексные задачи (long-term ai)

Следует отделать Bug (исправление к существующей функциональности) от feature requests (добавление новой функциональности) при создании AI

Хорошая AI должна **четко описывать конечное определенное/ограниченное действие**
Плохой пример:
 - разобраться как мониторить такое поведение
 - починить проблему инцидента
 - убедится что инжинеры проверяют схему БД перед проведением работ
Хороший пример:
 - добавить алерт на повышение кол-ва ошибок этого сервиса больше чем на 1%
 - сделать обработку входные данных пользователя через эту форму более безопастно, написать юнит-тесты
 - добавить автоматическую проверку схемы БД перед деплоем

#### Приоритезация AI

 - P0: высокий риск повторения инцидента если этот AI не будет закрыт. Точно убирает источрик проблемы (root cause) или сильно снижает impact (последствия)
 - P1: средний риск повторения инцидента если этот AI не будет закрыт. Слегка облегчает последствия инцидента или повышает шанс того, что он не возникнет
 - P2: небольшой риск. AI, направлениие на улучшение сопствующих частей потенциально задетой части системы или сильно специфичном случае, когда это может случиться
 - P3: совсем небольшие, минорные улучшения, координально не влияющие на повторение инцидента

Рекомендуется в каждом постмортеме иметь хотя бы один AI уровня P0 или P1

#### Разборы инцидента
Как можно скорее после инцидента нужно сделать его разбор. Пробежаться еще раз по таймлайну, действиям, выученным из него урокам, просмотреть AI. Можно делать это только вместе с задействованными в нем командами, или же делать его открытым.

#### Закрытие инцидентов
Надо стараться закрывать AI, не держать их долго открытыми. Если AI невозможно закрыть или он очень сложновыполнимый - он просто отвлекает вас от закрытия действительно нужных AI.
Хорошая идея периодически проводить ревизию открытых AI или построить отчет по их сгоранию/открытию (burndown diagram). Можно попробовтаь строить графики и статистики по сгоранию AI для каждого постмортема и вести статистику дней, через сколько все AI для определенного постмортема будут закрыты.
Неплохо когда топ-менеджеры компании иногда просматривают бэклог открытых постмортемов и поднимают выжные, критичные AI по критичным постмортемам.

### Структурные Анти-паттерны AI

#### Несбалансированные план
Если у вас весь список AI состоит только из долгих, больших, трудновыполнимых задач, то скорее всего вы не захотите их брать и делать до следующего подобного инцидента. С друго стороны если у вас только мелки исправаления и добавления небольших костылей и подпорок, то значит вы действительно не исправите корневую проблему, т.к. скорее всего для этого нужно поменять всю архитектуру.
Хороший AI-план должен состоять как из тактических фиксов, так и стратегических улучшений вашей системы.

#### Перебрасывание через стену
Часто в инциденте учавствует несколько команд, AI план включает действия со стороны других команд. Надо обсудить и согласовать конкретные AI с друго командой, а не просто кинуть им задачу на улучшение и делать вид что с вашей стороны все сделано и мяч на другой стороне у другой команды. Вы должны вместе сесть и прийти к конкретным действиям.

Прежде чем финализировать/публиковать постмортем, нужно убедиться что все вовлеченные в него команды с ним согласны. Если не удается присти к соглашение - зовем топов на помощь

#### Фокус только на предотвращении инцидента
Все AI направлены только на предотвращение инцидента, но нет AI на случай, если он все же произойдет опять. Например нет AI на мониторинг, уменьшение последствий, бекап и т.д.

#### Думать только об этом конкретном инциденте
Не стоит смотреть на инцидент узко, нужно стараться видеть полную картину и думать про другие постмортемы. Возможно вы можете сделать какие-то действия, который уберут последствия сразу нескольких инцидентов координельно. Стоит иногда простматривать и ревьювить старые открытые постмортемы и AI.

### Анти-паттерны, связанные с реализацией AI
## Отсутвие ответсвенного/исполнителя AI
Лучший способ никогда не закрыть AI - сделать его без указания ответсвенного/исполнителя. Если не знаете кто - назначте на кого-нибудь или на себя с первым заданием найти исполнителя этого AI (например тимлида команды). Лучшее место для AI - это ваш трекер задач

## Слишком специфичный мониторинг
Есть риск того, что слишком специфичный мониторинг, направленный именно на этот кейс, сработает только для данного случая. Лучше стараться делать мониторинг, который покрывает класс таких проблем.

## Чиним симптомы, а не источник проблем
Root cause analysis (RCA) можно провести по методике 5 why (5 почемучек) если трудно определить корневую причину.
5 Whys:
https://en.wikipedia.org/wiki/Five_whys
https://wa.aws.amazon.com/wellarchitected/2020-07-02T19-33-23/wat.concept.fivewhys.en.html
https://www.atlassian.com/incident-management/postmortem/5-whys

## Виним только людей/процессы, пропуская системные улучшение
Винить людей толку мало, чаще всего человек совершил ошибку потому что система позволяет ему эту ошибку совершить. В этом случае надо помоч человеку не совершить ошибку и, например, добавить каких-то предохранителей от человеческой ошибки или больше информации для принятия правильного решения. Поставте себя на место проснувшегося в 4 утра дежурного.

## Фиксим проблему на позднем этапе
Например добавляем проверку того, что файл корректный на этапе резворачиния в продакшене, хотя правильнее добавить линтеры, тестовую среду, обучение на более ранних этапах.
